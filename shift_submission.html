<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif;
            background-color: #f0f2f5;
            color: #212529;
            font-size: 14px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ffffff;
            padding: 1rem 1.5rem;
            border-radius: 0.375rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            position: sticky;
            top: 0;
            z-index: 100;
            margin-bottom: 1rem;
        }

        .back-link {
            font-size: 1.25rem;
            font-weight: bold;
            color: #212529;
            text-decoration: none;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-selector select,
        .date-selector span {
            border: none;
            background: none;
            font-size: 1.25rem;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .date-selector select {
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            padding-right: 1.5rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 16px 12px;
            cursor: pointer;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .submit-button-container {
            text-align: right;
            margin-bottom: 1rem;
        }

        .submit-button {
            padding: 0.75rem 2rem;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-button:hover {
            background: #357abd;
        }

        /* ã‚·ãƒ•ãƒˆè¡¨ */
        .shift-table-container {
            background-color: #ffffff;
            border-radius: 0.375rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            padding: 1.5rem;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .calendar-day-header {
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .calendar-day-header:nth-child(7n) {
            border-right: none;
        }

        .calendar-day-header.sunday {
            color: #d32f2f;
        }

        .calendar-day-header.saturday {
            color: #1976d2;
        }

        .calendar-day {
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            min-height: 100px;
            padding: 12px;
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day:hover {
            background-color: #e3f2fd;
        }

        .calendar-day.empty {
            background-color: #f8f9fa;
            cursor: default;
        }

        .calendar-day.empty:hover {
            background-color: #f8f9fa;
        }

        .day-number {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .calendar-day.sunday .day-number {
            color: #d32f2f;
        }

        .calendar-day.saturday .day-number {
            color: #1976d2;
        }

        .shift-info {
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
            padding: 6px 8px;
            text-align: center;
            line-height: 1.4;
            border-radius: 4px;
        }

        .shift-info.shift-a {
            background-color: #fff3e0;
            color: #e65100;
        }

        .shift-info.shift-b {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .shift-info.shift-c {
            background-color: #f3e5f5;
            color: #4a148c;
        }

        .shift-info.shift-el {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        .shift-info.shift-n {
            background-color: #fce4ec;
            color: #880e4f;
        }

        .shift-info.shift-l {
            background-color: #fff9c4;
            color: #f57f17;
        }

        .shift-info.shift-sp {
            background-color: #e0f2f1;
            color: #004d40;
        }

        /* ãƒ›ãƒ¼ãƒ åˆ¥ã®èƒŒæ™¯è‰² */
        .calendar-day.home-a {
            background-color: rgba(255, 182, 193, 0.2);
        }

        .calendar-day.home-b {
            background-color: rgba(173, 216, 230, 0.2);
        }

        .calendar-day.home-c {
            background-color: rgba(144, 238, 144, 0.2);
        }

        .calendar-day.home-d {
            background-color: rgba(255, 218, 185, 0.2);
        }

        .calendar-day.home-e {
            background-color: rgba(221, 160, 221, 0.2);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #ffffff;
            margin: auto;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .modal-close {
            font-size: 1.75rem;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: #212529;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body .form-group {
            margin-bottom: 1rem;
        }

        .modal-body label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .modal-body .form-value {
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            font-size: 0.9rem;
        }

        .modal-body .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            font-size: 0.9rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid #dee2e6;
        }

        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: bold;
            text-align: center;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-cancel {
            background-color: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background-color: #5a6268;
        }

        .btn-save {
            background-color: #007bff;
            color: white;
        }

        .btn-save:hover {
            background-color: #0056b3;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media screen and (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .calendar-day {
                min-height: 80px;
                padding: 8px;
            }

            .day-number {
                font-size: 14px;
            }

            .shift-info {
                font-size: 11px;
                padding: 4px 6px;
            }

            .calendar-day-header {
                padding: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ã‚·ãƒ•ãƒˆå¸Œæœ›å…¥åŠ›</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <div id="modal-date" class="form-value"></div>
                </div>
                <div class="form-group">
                    <label>ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰</label>
                    <select id="modal-shift-code" class="form-control">
                        <option value="NONE">æœªå®š</option>
                        <option value="A">Aï¼ˆæ—¥å‹¤ï¼š10æ™‚ï½19æ™‚ï¼‰</option>
                        <option value="B">Bï¼ˆå¤œå‹¤ï¼š22æ™‚ï½7æ™‚ï¼‰</option>
                        <option value="C">Cï¼ˆé…ç•ªï¼š13æ™‚ï½22æ™‚ï¼‰</option>
                        <option value="EL">ELï¼ˆæ—©æœï¼š7æ™‚ï½10æ™‚ï¼‰</option>
                        <option value="N">Nï¼ˆå…¬ä¼‘ï¼‰</option>
                        <option value="L">Lï¼ˆæœ‰ä¼‘ï¼‰</option>
                        <option value="SP">SPï¼ˆç‰¹ä¼‘ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ›ãƒ¼ãƒ </label>
                    <select id="modal-home" class="form-control">
                        <option value="">æŒ‡å®šãªã—</option>
                        <!-- ãƒ›ãƒ¼ãƒ é¸æŠè‚¢ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="modal-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-save" id="modal-save-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="app-header">
            <a href="shift_home_staff.html" class="back-link">â† æˆ»ã‚‹</a>
            <div class="date-selector">
                <select id="year-select">
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
                <span>å¹´</span>
                <select id="month-select">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                </select>
                <span>æœˆ</span>
            </div>
            <div style="width: 60px;"></div>
        </header>

        <!-- æå‡ºãƒœã‚¿ãƒ³ -->
        <div class="submit-button-container">
            <button class="submit-button" onclick="submitShift()">ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’æå‡º</button>
        </div>

        <!-- ã‚·ãƒ•ãƒˆè¡¨ -->
        <div class="shift-table-container">
            <div class="calendar" id="calendar">
                <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯JavaScriptã§ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // ã‚·ãƒ•ãƒˆæå‡ºç”»é¢å°‚ç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆ
        const submissionAppState = {
            currentYear: 2025,
            currentMonth: 11,
            myShifts: {},
            editingDate: null,
            isSubmitted: false  // æå‡ºæ¸ˆã¿ãƒ•ãƒ©ã‚°
        };

        // SHIFT_CODESã¯script.jsã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¾ã™

        let submissionDom = {};
        let submissionInitialized = false; // åˆæœŸåŒ–ãƒ•ãƒ©ã‚°

        document.addEventListener('DOMContentLoaded', () => {
            // script.jsã®åˆæœŸåŒ–ã‚’å¾…ã¤
            if (submissionInitialized) return;
            submissionInitialized = true;
            
            submissionDom = {
                yearSelect: document.getElementById('year-select'),
                monthSelect: document.getElementById('month-select'),
                calendar: document.getElementById('calendar'),
                modal: document.getElementById('edit-modal'),
                modalCloseBtn: document.querySelector('.modal-close'),
                modalCancelBtn: document.getElementById('modal-cancel-btn'),
                modalSaveBtn: document.getElementById('modal-save-btn'),
                modalDate: document.getElementById('modal-date'),
                modalShiftCode: document.getElementById('modal-shift-code'),
                modalHome: document.getElementById('modal-home'),
            };

            // åˆæœŸè¡¨ç¤ºã‚’ç¿Œæœˆã«è¨­å®š
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            submissionAppState.currentYear = nextMonth.getFullYear();
            submissionAppState.currentMonth = nextMonth.getMonth() + 1;

            // é¸æŠè‚¢ã‚’ä»Šæœˆã¨æ¥æœˆã®ã¿ã«åˆ¶é™
            populateMonthYearSelectors();

            setupEventListeners();
            submissionRender(); // script.jsã®render()ã¨åŒºåˆ¥

            submissionDom.yearSelect.value = submissionAppState.currentYear;
            submissionDom.monthSelect.value = submissionAppState.currentMonth;
            
            // æå‡ºæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªï¼ˆéå»ã®æœˆã§ã‚‚è¡¨ç¤ºï¼‰
            checkSubmittedData();
        });

        function populateMonthYearSelectors() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // 1-12
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            const nextYear = nextMonth.getFullYear();
            const nextMonthNum = nextMonth.getMonth() + 1;

            // å¹´é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
            submissionDom.yearSelect.innerHTML = '';
            const years = new Set([currentYear, nextYear]);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                submissionDom.yearSelect.appendChild(option);
            });

            // æœˆé¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
            submissionDom.monthSelect.innerHTML = '';
            
            // ä»Šæœˆ
            const currentOption = document.createElement('option');
            currentOption.value = currentMonth;
            currentOption.textContent = `${currentMonth}æœˆï¼ˆä»Šæœˆï¼‰`;
            submissionDom.monthSelect.appendChild(currentOption);
            
            // æ¥æœˆ
            const nextOption = document.createElement('option');
            nextOption.value = nextMonthNum;
            nextOption.textContent = `${nextMonthNum}æœˆï¼ˆæ¥æœˆï¼‰`;
            submissionDom.monthSelect.appendChild(nextOption);
        }

        async function checkSubmittedData() {
            console.log('ğŸ”„ checkSubmittedData() é–‹å§‹');
            
            try {
                const token = localStorage.getItem('shift_auth_token');
                if (!token) {
                    console.warn('âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                // è‡ªåˆ†ã®user_idã‚’å–å¾—
                const user = AUTH ? AUTH.getUser() : null;
                if (!user) {
                    console.warn('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                const myUserId = user.id || user.username || user.user_id;
                console.log('ğŸ‘¤ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user, 'user_id:', myUserId);
                
                // ç¾åœ¨ã®å¹´æœˆ
                const now = new Date();
                const selectedDate = new Date(submissionAppState.currentYear, submissionAppState.currentMonth - 1, 1);
                const currentMonthDate = new Date(now.getFullYear(), now.getMonth(), 1);
                const isPastMonth = selectedDate < currentMonthDate;

                // APIã‹ã‚‰æå‡ºæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                console.log(`ğŸ” ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹: ${API_BASE_URL}/api/shift-requests/get?year=${submissionAppState.currentYear}&month=${submissionAppState.currentMonth}`);
                
                const response = await fetch(
                    `${API_BASE_URL}/api/shift-requests/get?year=${submissionAppState.currentYear}&month=${submissionAppState.currentMonth}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                console.log(`ğŸ“¡ ãƒ¬ã‚¹ãƒãƒ³ã‚¹: status=${response.status}, ok=${response.ok}`);

                if (!response.ok) {
                    console.error(`âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: ${response.status} ${response.statusText}`);
                    try {
                        const errorData = await response.json();
                        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', errorData);
                    } catch (e) {
                        const errorText = await response.text();
                        console.error('ã‚¨ãƒ©ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ:', errorText);
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€éå»ã®æœˆãªã‚‰ç·¨é›†ä¸å¯
                    if (isPastMonth) {
                        submissionAppState.isSubmitted = true;
                    }
                    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
                    submissionRender();
                    updateSubmitButtonState();
                    return;
                }

                const data = await response.json();
                console.log('ğŸ“¦ å–å¾—ãƒ‡ãƒ¼ã‚¿:', data);
                
                if (!data.success || !data.shifts) {
                    console.warn('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãªã—ã€ã¾ãŸã¯ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹');
                    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€éå»ã®æœˆãªã‚‰ç·¨é›†ä¸å¯
                    if (isPastMonth) {
                        submissionAppState.isSubmitted = true;
                    }
                    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
                    submissionRender();
                    updateSubmitButtonState();
                    return;
                }

                // è‡ªåˆ†ã®æå‡ºæ¸ˆã¿ã‚·ãƒ•ãƒˆã‚’æŠ½å‡º
                let hasSubmitted = false;
                submissionAppState.myShifts = {}; // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                
                console.log('ğŸ” APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“:', data);
                
                Object.entries(data.shifts).forEach(([dateStr, homes]) => {
                    const [y, m, day] = dateStr.split('-').map(Number);
                    
                    Object.entries(homes).forEach(([home, shiftCodes]) => {
                        Object.entries(shiftCodes).forEach(([shiftCode, users]) => {
                            users.forEach(userShift => {
                                console.log(`  æ—¥ä»˜${day}: user_id=${userShift.user_id}, status=${userShift.status}, è‡ªåˆ†=${myUserId}`);
                                
                                // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡ºï¼ˆstatusã«é–¢ã‚ã‚‰ãšå…¨ã¦å–å¾—ï¼‰
                                if (userShift.user_id === myUserId) {
                                    hasSubmitted = true;
                                    submissionAppState.myShifts[day] = {
                                        code: shiftCode,
                                        home: home === 'æœªå®š' ? '' : home,
                                        status: userShift.status // statusã‚‚ä¿å­˜
                                    };
                                }
                            });
                        });
                    });
                });
                
                console.log('ğŸ“Š æå‡ºæ¸ˆã¿ã‚·ãƒ•ãƒˆå–å¾—:', {
                    å¹´æœˆ: `${submissionAppState.currentYear}å¹´${submissionAppState.currentMonth}æœˆ`,
                    æå‡ºæ¸ˆã¿: hasSubmitted,
                    ã‚·ãƒ•ãƒˆæ—¥æ•°: Object.keys(submissionAppState.myShifts).length,
                    ãƒ‡ãƒ¼ã‚¿: submissionAppState.myShifts
                });

                if (hasSubmitted) {
                    // æå‡ºæ¸ˆã¿ã®å ´åˆã¯ç·¨é›†ä¸å¯
                    submissionAppState.isSubmitted = true;
                    
                    // ä»Šæœˆã¾ãŸã¯æ¥æœˆã®å ´åˆã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const shiftCount = Object.keys(submissionAppState.myShifts).length;
                    if (!isPastMonth) {
                        console.log(`âœ… ã“ã®æœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã¯æ—¢ã«æå‡ºæ¸ˆã¿ã§ã™ï¼ˆ${shiftCount}æ—¥åˆ†ï¼‰`);
                    }
                } else {
                    // æå‡ºãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
                    if (isPastMonth) {
                        // éå»ã®æœˆã§æœªæå‡ºã®å ´åˆã¯ç·¨é›†ä¸å¯ï¼ˆé–²è¦§ã®ã¿ï¼‰
                        submissionAppState.isSubmitted = true;
                    } else {
                        // ä»Šæœˆã¾ãŸã¯æ¥æœˆã§æœªæå‡ºã®å ´åˆã¯ç·¨é›†å¯èƒ½
                        submissionAppState.isSubmitted = false;
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
                submissionRender();
                updateSubmitButtonState();

            } catch (error) {
                console.error('âŒâŒâŒ æå‡ºæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', error.stack);
                
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€éå»ã®æœˆãªã‚‰ç·¨é›†ä¸å¯
                const now = new Date();
                const selectedDate = new Date(submissionAppState.currentYear, submissionAppState.currentMonth - 1, 1);
                const currentMonthDate = new Date(now.getFullYear(), now.getMonth(), 1);
                
                if (selectedDate < currentMonthDate) {
                    submissionAppState.isSubmitted = true;
                    updateSubmitButtonState();
                }
            }
        }

        function setupEventListeners() {
            submissionDom.yearSelect.addEventListener('change', handleDateChange);
            submissionDom.monthSelect.addEventListener('change', handleDateChange);
            submissionDom.calendar.addEventListener('click', handleCellClick);
            submissionDom.modalCloseBtn.addEventListener('click', closeModal);
            submissionDom.modalCancelBtn.addEventListener('click', closeModal);
            submissionDom.modalSaveBtn.addEventListener('click', handleModalSave);
        }

        async function handleDateChange() {
            // é¸æŠã•ã‚ŒãŸæœˆã«å¿œã˜ã¦å¹´ã‚’è‡ªå‹•èª¿æ•´
            const selectedMonth = parseInt(submissionDom.monthSelect.value, 10);
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            
            // é¸æŠã•ã‚ŒãŸæœˆãŒä»Šæœˆã‚ˆã‚Šå°ã•ã„å ´åˆã¯æ¥å¹´
            if (selectedMonth < currentMonth) {
                submissionAppState.currentYear = now.getFullYear() + 1;
            } else {
                submissionAppState.currentYear = now.getFullYear();
            }
            
            submissionAppState.currentMonth = selectedMonth;
            submissionAppState.myShifts = {}; // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            submissionAppState.isSubmitted = false;
            
            console.log(`ğŸ“… æœˆåˆ‡ã‚Šæ›¿ãˆ: ${submissionAppState.currentYear}å¹´${submissionAppState.currentMonth}æœˆ`);
            
            // å¹´é¸æŠè‚¢ã‚’æ›´æ–°
            submissionDom.yearSelect.value = submissionAppState.currentYear;
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æå‡ºæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆéåŒæœŸï¼‰
            // checkSubmittedDataå†…ã§render()ã¨updateSubmitButtonState()ãŒå‘¼ã°ã‚Œã‚‹
            await checkSubmittedData();
        }

        function updateSubmitButtonState() {
            const submitBtn = document.querySelector('.submit-button');
            if (submitBtn) {
                // éå»ã®æœˆã‹ãƒã‚§ãƒƒã‚¯
                const now = new Date();
                const selectedDate = new Date(submissionAppState.currentYear, submissionAppState.currentMonth - 1, 1);
                const currentMonthDate = new Date(now.getFullYear(), now.getMonth(), 1);
                const isPastMonth = selectedDate < currentMonthDate;
                const shiftCount = Object.keys(submissionAppState.myShifts).length;
                
                if (submissionAppState.isSubmitted || isPastMonth) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                    submitBtn.style.cursor = 'not-allowed';
                    
                    if (shiftCount > 0) {
                        submitBtn.textContent = `âœ“ æå‡ºæ¸ˆã¿ï¼ˆ${shiftCount}æ—¥åˆ†ï¼‰`;
                    } else if (isPastMonth) {
                        submitBtn.textContent = 'éå»ã®æœˆï¼ˆé–²è¦§ã®ã¿ï¼‰';
                    } else {
                        submitBtn.textContent = 'æå‡ºæ¸ˆã¿';
                    }
                } else {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                    
                    if (shiftCount > 0) {
                        submitBtn.textContent = `ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’æå‡ºï¼ˆ${shiftCount}æ—¥åˆ†å…¥åŠ›æ¸ˆã¿ï¼‰`;
                    } else {
                        submitBtn.textContent = 'ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’æå‡º';
                    }
                }
            }
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        function getFirstDayOfMonth(year, month) {
            return new Date(year, month - 1, 1).getDay(); // 0=æ—¥æ›œ, 6=åœŸæ›œ
        }

        function getDayOfWeek(year, month, day) {
            return new Date(year, month - 1, day).getDay();
        }

        function submissionRender() {
            const daysInMonth = getDaysInMonth(submissionAppState.currentYear, submissionAppState.currentMonth);
            const firstDay = getFirstDayOfMonth(submissionAppState.currentYear, submissionAppState.currentMonth);
            
            let calendarHtml = '';
            
            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
            const dayHeaders = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            dayHeaders.forEach((day, index) => {
                const className = index === 0 ? 'sunday' : (index === 6 ? 'saturday' : '');
                calendarHtml += `<div class="calendar-day-header ${className}">${day}</div>`;
            });
            
            // æœˆåˆã‚ã¾ã§ã®ç©ºã‚»ãƒ«
            for (let i = 0; i < firstDay; i++) {
                calendarHtml += '<div class="calendar-day empty"></div>';
            }
            
            // æ—¥ä»˜ã‚»ãƒ«
            for (let day = 1; day <= daysInMonth; day++) {
                const dayOfWeek = getDayOfWeek(submissionAppState.currentYear, submissionAppState.currentMonth, day);
                const shift = submissionAppState.myShifts[day] || { code: 'NONE', home: '' };
                const shiftInfo = SHIFT_CODES[shift.code] || SHIFT_CODES['NONE'];
                
                let dayClass = 'calendar-day';
                if (dayOfWeek === 0) dayClass += ' sunday';
                if (dayOfWeek === 6) dayClass += ' saturday';
                if (shift.home) dayClass += ` home-${shift.home.toLowerCase()}`;
                
                calendarHtml += `<div class="${dayClass}" data-date="${day}">`;
                calendarHtml += `<div class="day-number">${day}</div>`;
                
                if (shift.code !== 'NONE') {
                    calendarHtml += `<div class="shift-info ${shiftInfo.class}">${shift.code}</div>`;
                }
                
                calendarHtml += '</div>';
            }
            
            submissionDom.calendar.innerHTML = calendarHtml;
        }

        function handleCellClick(event) {
            // æå‡ºæ¸ˆã¿ã®å ´åˆã¯ç·¨é›†ä¸å¯
            if (submissionAppState.isSubmitted) {
                // éå»ã®æœˆã‹ãƒã‚§ãƒƒã‚¯
                const now = new Date();
                const selectedDate = new Date(submissionAppState.currentYear, submissionAppState.currentMonth - 1, 1);
                const currentMonthDate = new Date(now.getFullYear(), now.getMonth(), 1);
                const isPastMonth = selectedDate < currentMonthDate;
                
                if (isPastMonth) {
                    alert('éå»ã®æœˆã¯ç·¨é›†ã§ãã¾ã›ã‚“ï¼ˆé–²è¦§ã®ã¿ï¼‰');
                } else {
                    alert('æå‡ºæ¸ˆã¿ã®ãŸã‚ç·¨é›†ã§ãã¾ã›ã‚“');
                }
                return;
            }
            
            const cell = event.target.closest('.calendar-day');
            if (!cell || cell.classList.contains('empty')) return;
            
            const date = cell.dataset.date;
            if (!date) return;

            submissionAppState.editingDate = date;
            const currentShift = submissionAppState.myShifts[date] || { code: 'NONE', home: '' };
            
            openModal(date, currentShift);
        }

        function openModal(date, currentShift) {
            submissionDom.modalDate.textContent = `${submissionAppState.currentYear}å¹´${submissionAppState.currentMonth}æœˆ${date}æ—¥`;
            submissionDom.modalShiftCode.value = currentShift.code;
            submissionDom.modalHome.value = currentShift.home || '';
            
            submissionDom.modal.classList.add('show');
        }

        function closeModal() {
            submissionDom.modal.classList.remove('show');
            submissionAppState.editingDate = null;
        }

        function handleModalSave() {
            if (!submissionAppState.editingDate) return;
            
            const newCode = submissionDom.modalShiftCode.value;
            const newHome = submissionDom.modalHome.value;

            submissionAppState.myShifts[submissionAppState.editingDate] = { code: newCode, home: newHome };
            
            closeModal();
            submissionRender();
            updateSubmitButtonState(); // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
        }

        async function submitShift() {
            // æå‡ºæ¸ˆã¿ãƒã‚§ãƒƒã‚¯
            if (submissionAppState.isSubmitted) {
                alert('æ—¢ã«æå‡ºæ¸ˆã¿ã§ã™');
                return;
            }
            
            const shiftCount = Object.keys(submissionAppState.myShifts).length;
            if (shiftCount === 0) {
                alert('ã‚·ãƒ•ãƒˆå¸Œæœ›ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            if (confirm(`${submissionAppState.currentYear}å¹´${submissionAppState.currentMonth}æœˆã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’æå‡ºã—ã¾ã™ã‹ï¼Ÿ\nå…¥åŠ›æ¸ˆã¿: ${shiftCount}æ—¥åˆ†`)) {
                try {
                    const token = localStorage.getItem('shift_auth_token');
                    if (!token) {
                        alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                        window.location.href = window.BASE_PATH || '/shift/';
                        return;
                    }

                    console.log('ğŸ“¤ æå‡ºãƒ‡ãƒ¼ã‚¿:', submissionAppState.myShifts);

                    const response = await fetch(`${API_BASE_URL}/api/shift-requests/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            year: submissionAppState.currentYear,
                            month: submissionAppState.currentMonth,
                            shifts: submissionAppState.myShifts
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ã‚·ãƒ•ãƒˆå¸Œæœ›ã®æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }

                    console.log('âœ… æå‡ºæˆåŠŸ:', data);
                    alert(`ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’æå‡ºã—ã¾ã—ãŸï¼\nä¿å­˜ä»¶æ•°: ${data.saved_count}ä»¶`);
                    
                    // æå‡ºå¾Œã¯ç·¨é›†ä¸å¯ã«
                    submissionAppState.isSubmitted = true;
                    updateSubmitButtonState();
                } catch (error) {
                    console.error('âŒ æå‡ºã‚¨ãƒ©ãƒ¼:', error);
                    alert('ã‚·ãƒ•ãƒˆå¸Œæœ›ã®æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        }
    </script>
    
    <!-- APIè¨­å®šã‚’å…ˆã«èª­ã¿è¾¼ã‚€ -->
    <script src="config.js"></script>
    <!-- èªè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="auth.js"></script>
    
    <script>
        // script.jsã‹ã‚‰å¿…è¦ãªé–¢æ•°ã®ã¿ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®æº–å‚™
        // SHIFT_CODESã®å®šç¾©ã‚’ã“ã“ã«è¿½åŠ 
        if (typeof SHIFT_CODES === 'undefined') {
            window.SHIFT_CODES = {
                A: { name: 'æ—¥å‹¤', time: '10æ™‚ï½19æ™‚', class: 'shift-a' },
                B: { name: 'å¤œå‹¤', time: '22æ™‚ï½7æ™‚', class: 'shift-b' },
                C: { name: 'é…ç•ª', time: '13æ™‚ï½22æ™‚', class: 'shift-c' },
                EL: { name: 'æ—©æœ', time: '7æ™‚ï½10æ™‚', class: 'shift-el' },
                N: { name: 'å…¬ä¼‘', time: '', class: 'shift-n' },
                L: { name: 'æœ‰ä¼‘', time: '', class: 'shift-l' },
                SP: { name: 'ç‰¹ä¼‘', time: '', class: 'shift-sp' },
                NONE: { name: 'æœªå®š', time: '', class: 'shift-none' }
            };
        }
        
        // loadHomesListã¨populateHomeSelectã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function loadHomesList() {
            const CACHE_KEY = 'shift_homes_cache';
            const CACHE_TIMESTAMP_KEY = 'shift_homes_cache_timestamp';
            const CACHE_DURATION = 5 * 60 * 1000;
            
            const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
            if (timestamp) {
                const age = Date.now() - parseInt(timestamp);
                if (age < CACHE_DURATION) {
                    const cached = localStorage.getItem(CACHE_KEY);
                    if (cached) {
                        try {
                            return JSON.parse(cached);
                        } catch (e) {
                            console.error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥è§£æã‚¨ãƒ©ãƒ¼:', e);
                        }
                    }
                }
            }
            
            try {
                const token = localStorage.getItem('shift_auth_token');
                if (!token) return ['A', 'B', 'C', 'D', 'E'];
                
                const response = await fetch(`${API_BASE_URL}/api/homes`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('ãƒ›ãƒ¼ãƒ å–å¾—å¤±æ•—');
                
                const data = await response.json();
                
                if (data.success && data.homes && data.homes.length > 0) {
                    const homes = data.homes.map(h => h.name);
                    localStorage.setItem(CACHE_KEY, JSON.stringify(homes));
                    localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
                    return homes;
                }
                return ['A', 'B', 'C', 'D', 'E'];
            } catch (error) {
                console.error('âŒ ãƒ›ãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return ['A', 'B', 'C', 'D', 'E'];
            }
        }
        
        async function populateHomeSelect(selectElement, options = {}) {
            if (!selectElement) return;
            
            const { includeUndecided = false } = options;
            const homes = await loadHomesList();
            
            selectElement.innerHTML = '';
            
            homes.forEach((home) => {
                if (home === 'æœªå®š' && !includeUndecided) return;
                const option = document.createElement('option');
                option.value = home;
                option.textContent = `${home}ãƒ›ãƒ¼ãƒ `;
                selectElement.appendChild(option);
            });
        }
    </script>
    
    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
        document.addEventListener('DOMContentLoaded', async () => {
            // ãƒ›ãƒ¼ãƒ é¸æŠè‚¢ã‚’å‹•çš„ç”Ÿæˆ
            const modalHome = document.getElementById('modal-home');
            if (modalHome && typeof populateHomeSelect === 'function') {
                await populateHomeSelect(modalHome, { includeUndecided: false });
                
                // "æŒ‡å®šãªã—"ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å…ˆé ­ã«è¿½åŠ ï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’å‰Šé™¤ã—ã¦å†ä½œæˆï¼‰
                const existingEmpty = modalHome.querySelector('option[value=""]');
                if (existingEmpty) {
                    existingEmpty.remove();
                }
                
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'æŒ‡å®šãªã—';
                modalHome.insertBefore(emptyOption, modalHome.firstChild);
            }
            
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (typeof PageRouter !== 'undefined') {
                const hasAccess = await PageRouter.checkPageAccess();
                if (!hasAccess) {
                    return; // èªè¨¼å¤±æ•—æ™‚ã¯å‡¦ç†ã‚’ä¸­æ–­
                }
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const user = AUTH ? AUTH.getUser() : null;
            if (user) {
                console.log('ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.name, `(${user.role})`);
            }
            
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å®Ÿè£…
            const backLink = document.querySelector('.back-link');
            if (backLink) {
                backLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                    const user = AUTH ? AUTH.getUser() : null;
                    
                    if (user) {
                        // ãƒ­ãƒ¼ãƒ«ã«å¿œã˜ã¦ãƒ›ãƒ¼ãƒ ç”»é¢ã¸é·ç§»
                        if (user.role === 'admin') {
                            window.location.href = 'shift_home_admin.html';
                        } else {
                            window.location.href = 'shift_home_staff.html';
                        }
                    } else {
                        // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯
                        window.history.back();
                    }
                });
            }
        });
    </script>
</body>
</html>
