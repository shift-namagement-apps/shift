<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ•ãƒˆè¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* ã‚·ãƒ•ãƒˆè¡¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
        .shift-table-container {
            max-height: calc(10 * 50px + 60px); /* 10äººåˆ†ã®é«˜ã• + ãƒ˜ãƒƒãƒ€ãƒ¼ */
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .shift-table {
            width: auto;
            min-width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        /* ã‚¹ã‚¿ãƒƒãƒ•ååˆ—ã‚’å›ºå®š */
        .shift-table thead th:first-child,
        .shift-table tbody td:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            border-right: 2px solid #ddd;
        }
        
        .shift-table thead th:first-child {
            z-index: 20;
            background: #f8f9fa;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®é«˜ã•å›ºå®š */
        .shift-table tbody tr {
            height: 50px;
        }
        
        .shift-table tbody td {
            min-width: 80px;
            max-width: 80px;
            width: 80px;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #e0e0e0;
            padding: 4px;
        }
        
        .shift-table tbody td:first-child {
            min-width: 150px;
            max-width: 150px;
            width: 150px;
            text-align: left;
            padding-left: 12px;
            font-weight: 500;
        }
        
        .shift-table thead th {
            min-width: 80px;
            max-width: 80px;
            width: 80px;
            text-align: center;
            padding: 12px 4px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 15;
        }
        
        .shift-table thead th:first-child {
            min-width: 150px;
            max-width: 150px;
            width: 150px;
            text-align: left;
            padding-left: 12px;
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .shift-table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        .shift-table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        .shift-table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }
        
        .shift-table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ã‚·ãƒ•ãƒˆç·¨é›†</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
                    <div id="modal-staff-name" class="form-value"></div>
                </div>
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <div id="modal-date" class="form-value"></div>
                </div>
                <div class="form-group">
                    <label>ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰</label>
                    <select id="modal-shift-code" class="form-control">
                        <!-- ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ã¯å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                        <option value="NONE">æœªå®š</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ›ãƒ¼ãƒ </label>
                    <select id="modal-home" class="form-control">
                        <!-- ãƒ›ãƒ¼ãƒ é¸æŠè‚¢ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="modal-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-save" id="modal-save-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="app-container">

        <nav class="sidebar-left">
            <div class="form-group">
                <label for="home-select">è¡¨ç¤ºãƒ›ãƒ¼ãƒ </label>
                <select id="home-select">
                    <!-- ãƒ›ãƒ¼ãƒ é¸æŠè‚¢ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </select>
            </div>

            <h3>ã‚·ãƒ•ãƒˆè¦æœ›</h3>
            <ul class="shift-request-list" id="shift-request-list">
            </ul>
            <button class="btn btn-reflect-all" id="reflect-all-btn" onclick="bulkApproveShiftRequests()">ã™ã¹ã¦ä¸€æ‹¬æ‰¿èª</button>
        </nav>

        <div class="main-wrapper">
            <header class="app-header">
                <a href="#" class="back-link">â† æˆ»ã‚‹</a>
                <div class="date-selector">
                    <select id="year-select">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <span>å¹´</span>
                    <select id="month-select">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                    <span>æœˆ</span>
                </div>
                <button id="export-sheet-btn" onclick="exportToSpreadsheet()" style="
                    background: #1a73e8;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 8px 16px;
                    font-size: 14px;
                    font-weight: bold;
                    cursor: pointer;
                    white-space: nowrap;
                ">ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸å‡ºåŠ›</button>
            </header>

            <main class="main-content">
                <div class="shift-table-container">
                    <table class="shift-table" id="shift-table">
                        <thead id="shift-table-header">
                            </thead>
                        <tbody id="shift-table-body">
                            </tbody>
                    </table>
                </div>

                <h3 class="daily-summary-title">ãƒ›ãƒ¼ãƒ åˆ¥æ—¥æ¬¡é›†è¨ˆ</h3>
                <div class="summary-table-container">
                    <div class="daily-summary-header">
                        <label for="daily-summary-home-select">é›†è¨ˆå¯¾è±¡ï¼š</label>
                        <select id="daily-summary-home-select">
                            <!-- ãƒ›ãƒ¼ãƒ é¸æŠè‚¢ã¯å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                            <option value="A">Aãƒ›ãƒ¼ãƒ </option>
                            <option value="B">Bãƒ›ãƒ¼ãƒ </option>
                            <option value="C">Cãƒ›ãƒ¼ãƒ </option>
                            <option value="D">Dãƒ›ãƒ¼ãƒ </option>
                            <option value="E">Eãƒ›ãƒ¼ãƒ </option>
                        </select>
                    </div>
                    <table class="summary-table" id="daily-summary-table">
                        <tbody id="daily-summary-body">
                            </tbody>
                    </table>
                </div>
            </main>
        </div>

        <aside class="sidebar-right">
            <div class="summary-card">
                <div class="summary-card-header">
                    æœˆé–“é›†è¨ˆ
                </div>
                <div class="summary-card-body">
                    <ul class="summary-list-group" id="monthly-summary">
                        </ul>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-card-header">
                    ãƒ›ãƒ¼ãƒ åˆ¥æœˆé–“åˆè¨ˆ
                </div>
                <div class="summary-card-body">
                    <ul class="summary-list-group home-summary-list" id="home-summary">
                        </ul>
                </div>
            </div>
        </aside>

    </div>

    <!-- APIè¨­å®šã‚’å…ˆã«èª­ã¿è¾¼ã‚€ -->
    <script src="config.js"></script>
    <!-- èªè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="auth.js"></script>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="script.js"></script>
    
    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
        document.addEventListener('DOMContentLoaded', async () => {
            // ãƒ›ãƒ¼ãƒ é¸æŠè‚¢ã‚’å‹•çš„ç”Ÿæˆ
            await populateHomeSelect(document.getElementById('home-select'), { includeAll: true });
            await populateHomeSelect(document.getElementById('modal-home'), { includeUndecided: true });
            await populateHomeSelect(document.getElementById('daily-summary-home-select'), { defaultValue: 'A' });
            
            // ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰é¸æŠè‚¢ã‚’å‹•çš„ç”Ÿæˆ
            await populateShiftCodeSelect(document.getElementById('modal-shift-code'));

            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (typeof PageRouter !== 'undefined') {
                const hasAccess = await PageRouter.checkPageAccess();
                if (!hasAccess) {
                    return; // èªè¨¼å¤±æ•—æ™‚ã¯å‡¦ç†ã‚’ä¸­æ–­
                }
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const user = AUTH ? AUTH.getUser() : null;
            if (user) {
                console.log('ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.name, `(${user.role})`);
            }
        });
        
        // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’è¨­å®š
        document.querySelector('.back-link')?.addEventListener('click', (e) => {
            e.preventDefault();
            window.history.back();
        });

        /**
         * ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰é¸æŠè‚¢ã‚’å‹•çš„ç”Ÿæˆï¼ˆAPIã‹ã‚‰å–å¾—ï¼‰
         */
        async function populateShiftCodeSelect(selectElement) {
            if (!selectElement) return;
            try {
                const token = localStorage.getItem('shift_auth_token');
                if (!token) return;

                const response = await fetch(`${API_BASE_URL}/api/shift-codes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰å–å¾—å¤±æ•—');
                const data = await response.json();

                if (data.success && data.codes && data.codes.length > 0) {
                    selectElement.innerHTML = '<option value="NONE">æœªå®š</option>';
                    data.codes.forEach(code => {
                        if (!code.active) return;
                        const option = document.createElement('option');
                        option.value = code.code;
                        // ãƒ©ãƒ™ãƒ«ã¨æ™‚é–“å¸¯ã‚’è¡¨ç¤ºï¼ˆä¾‹: Aï¼ˆæ—¥å‹¤ï¼š10æ™‚ï½19æ™‚ï¼‰ï¼‰
                        const hoursText = code.hours > 0 ? `  ${code.hours}h` : '';
                        option.textContent = `${code.code}ï¼ˆ${code.label}${hoursText}ï¼‰`;
                        selectElement.appendChild(option);
                    });
                    console.log('âœ… ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰é¸æŠè‚¢ã‚’å‹•çš„ç”Ÿæˆ:', data.codes.length + 'ä»¶');
                } else {
                    // APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
                    selectElement.innerHTML = `
                        <option value="NONE">æœªå®š</option>
                        <option value="A">Aï¼ˆæ—¥å‹¤ï¼‰</option>
                        <option value="B">Bï¼ˆå¤œå‹¤ï¼‰</option>
                        <option value="C">Cï¼ˆé…ç•ªï¼‰</option>
                        <option value="EL">ELï¼ˆæ—©æœï¼‰</option>
                        <option value="N">Nï¼ˆå…¬ä¼‘ï¼‰</option>
                        <option value="L">Lï¼ˆæœ‰ä¼‘ï¼‰</option>
                        <option value="SP">SPï¼ˆç‰¹ä¼‘ï¼‰</option>
                    `;
                }
            } catch (error) {
                console.warn('âš ï¸ ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨ï¼‰:', error);
                selectElement.innerHTML = `
                    <option value="NONE">æœªå®š</option>
                    <option value="A">Aï¼ˆæ—¥å‹¤ï¼‰</option>
                    <option value="B">Bï¼ˆå¤œå‹¤ï¼‰</option>
                    <option value="C">Cï¼ˆé…ç•ªï¼‰</option>
                    <option value="EL">ELï¼ˆæ—©æœï¼‰</option>
                    <option value="N">Nï¼ˆå…¬ä¼‘ï¼‰</option>
                    <option value="L">Lï¼ˆæœ‰ä¼‘ï¼‰</option>
                    <option value="SP">SPï¼ˆç‰¹ä¼‘ï¼‰</option>
                `;
            }
        }

        /**
         * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸å‡ºåŠ›ï¼ˆã‚·ãƒ¼ãƒˆ2ï¼šå…¨å“¡ä¸€è¦§ï¼‰
         */
        async function exportToSpreadsheet() {
            const btn = document.getElementById('export-sheet-btn');
            const originalText = btn.textContent;
            btn.textContent = 'â³ å‡ºåŠ›ä¸­...';
            btn.disabled = true;

            try {
                const token = localStorage.getItem('shift_auth_token');
                if (!token) {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }

                const year = appState.currentYear;
                const month = appState.currentMonth;

                if (!appState.staff || appState.staff.length === 0) {
                    alert('ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (!confirm(`${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆè¡¨ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚·ãƒ¼ãƒˆ2ã«å‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }

                console.log(`ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå‡ºåŠ›é–‹å§‹: ${year}å¹´${month}æœˆ`);

                const response = await fetch(`${API_BASE_URL}/api/shifts/export-to-sheet2`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        year: year,
                        month: month,
                        staff: appState.staff,
                        shifts: appState.shifts
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… å‡ºåŠ›å®Œäº†ï¼\n${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆè¡¨ã‚’ã‚·ãƒ¼ãƒˆ2ã«æ›¸ãè¾¼ã¿ã¾ã—ãŸã€‚\nï¼ˆã‚¹ã‚¿ãƒƒãƒ•æ•°: ${data.staff_count}åï¼‰`);
                    console.log('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå‡ºåŠ›æˆåŠŸ:', data);
                } else {
                    alert(`âŒ å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${data.error}`);
                    console.error('âŒ å‡ºåŠ›å¤±æ•—:', data);
                }
            } catch (error) {
                console.error('âŒ å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
