<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ•ãƒˆè¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
        .sidebar-left {
            display: none;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¹…ã‚’èª¿æ•´ */
        .app-container {
            display: flex;
            gap: 1.5rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 0;
        }
        
        /* ã‚·ãƒ•ãƒˆè¡¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
        .shift-table-container {
            max-height: calc(10 * 50px + 60px); /* 10äººåˆ†ã®é«˜ã• + ãƒ˜ãƒƒãƒ€ãƒ¼ */
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .shift-table {
            width: auto;
            min-width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        /* ã‚¹ã‚¿ãƒƒãƒ•ååˆ—ã‚’å›ºå®š */
        .shift-table thead th:first-child,
        .shift-table tbody td:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            border-right: 2px solid #ddd;
        }
        
        .shift-table thead th:first-child {
            z-index: 20;
            background: #f8f9fa;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®é«˜ã•å›ºå®š */
        .shift-table tbody tr {
            height: 50px;
        }
        
        .shift-table tbody td {
            min-width: 80px;
            max-width: 80px;
            width: 80px;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #e0e0e0;
            padding: 4px;
        }
        
        .shift-table tbody td:first-child {
            min-width: 150px;
            max-width: 150px;
            width: 150px;
            text-align: left;
            padding-left: 12px;
            font-weight: 500;
        }
        
        .shift-table thead th {
            min-width: 80px;
            max-width: 80px;
            width: 80px;
            text-align: center;
            padding: 12px 4px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 15;
        }
        
        .shift-table thead th:first-child {
            min-width: 150px;
            max-width: 150px;
            width: 150px;
            text-align: left;
            padding-left: 12px;
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .shift-table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        .shift-table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        .shift-table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }
        
        .shift-table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* ç©ºè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .shift-table tbody tr.empty-row td {
            background: #fafafa;
            border: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ã‚·ãƒ•ãƒˆç·¨é›†</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
                    <div id="modal-staff-name" class="form-value"></div>
                </div>
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <div id="modal-date" class="form-value"></div>
                </div>
                <div class="form-group">
                    <label>ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰</label>
                    <select id="modal-shift-code" class="form-control">
                        <option value="NONE">æœªå®š</option>
                        <option value="A">Aï¼ˆæ—¥å‹¤ï¼š10æ™‚ï½19æ™‚ï¼‰</option>
                        <option value="B">Bï¼ˆå¤œå‹¤ï¼š22æ™‚ï½7æ™‚ï¼‰</option>
                        <option value="C">Cï¼ˆé…ç•ªï¼š13æ™‚ï½22æ™‚ï¼‰</option>
                        <option value="EL">ELï¼ˆæ—©æœï¼š7æ™‚ï½10æ™‚ï¼‰</option>
                        <option value="N">Nï¼ˆå…¬ä¼‘ï¼‰</option>
                        <option value="L">Lï¼ˆæœ‰ä¼‘ï¼‰</option>
                        <option value="SP">SPï¼ˆç‰¹ä¼‘ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ›ãƒ¼ãƒ </label>
                    <select id="modal-home" class="form-control">
                        <option value="A">Aãƒ›ãƒ¼ãƒ </option>
                        <option value="B">Bãƒ›ãƒ¼ãƒ </option>
                        <option value="C">Cãƒ›ãƒ¼ãƒ </option>
                        <option value="D">Dãƒ›ãƒ¼ãƒ </option>
                        <option value="E">Eãƒ›ãƒ¼ãƒ </option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="modal-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-save" id="modal-save-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="app-container">

        <!-- éè¡¨ç¤ºã ãŒå¿…è¦ãªè¦ç´ ã‚’ä¿æŒ -->
        <nav class="sidebar-left">
            <div class="form-group">
                <label for="home-select">è¡¨ç¤ºãƒ›ãƒ¼ãƒ </label>
                <select id="home-select">
                    <option value="all">å…¨ä½“è¡¨ç¤º</option>
                    <option value="A">Aãƒ›ãƒ¼ãƒ </option>
                    <option value="B">Bãƒ›ãƒ¼ãƒ </option>
                    <option value="C">Cãƒ›ãƒ¼ãƒ </option>
                    <option value="D">Dãƒ›ãƒ¼ãƒ </option>
                    <option value="E">Eãƒ›ãƒ¼ãƒ </option>
                </select>
            </div>

            <h3>ã‚·ãƒ•ãƒˆè¦æœ›</h3>
            <ul class="shift-request-list" id="shift-request-list">
            </ul>

            <button class="btn btn-reflect-all" id="reflect-all-btn">ã™ã¹ã¦ä¸€æ‹¬åæ˜ </button>
        </nav>

        <div class="main-wrapper">
            <header class="app-header">
                <a href="#" class="back-link">â† æˆ»ã‚‹</a>
                <div class="date-selector">
                    <select id="year-select">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <span>å¹´</span>
                    <select id="month-select">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                    <span>æœˆ</span>
                </div>
                <div style="width: 60px;"></div>
            </header>

            <main class="main-content">
                <div class="shift-table-container">
                    <table class="shift-table" id="shift-table">
                        <thead id="shift-table-header">
                            </thead>
                        <tbody id="shift-table-body">
                            </tbody>
                    </table>
                </div>

                <h3 class="daily-summary-title">ãƒ›ãƒ¼ãƒ åˆ¥æ—¥æ¬¡é›†è¨ˆ</h3>
                <div class="summary-table-container">
                    <table class="summary-table" id="daily-summary-table">
                        <tbody id="daily-summary-body">
                            </tbody>
                    </table>
                </div>
            </main>
        </div>

        <aside class="sidebar-right">
            <div class="summary-card">
                <div class="summary-card-header">
                    æœˆé–“é›†è¨ˆ
                </div>
                <div class="summary-card-body">
                    <ul class="summary-list-group" id="monthly-summary">
                        </ul>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-card-header">
                    ãƒ›ãƒ¼ãƒ åˆ¥æœˆé–“åˆè¨ˆ
                </div>
                <div class="summary-card-body">
                    <ul class="summary-list-group home-summary-list" id="home-summary">
                        </ul>
                </div>
            </div>
        </aside>

    </div>

    <!-- APIè¨­å®šã‚’å…ˆã«èª­ã¿è¾¼ã‚€ -->
    <script src="config.js"></script>
    <!-- èªè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="auth.js"></script>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="script.js"></script>
    
    <script>
        // ã‚·ãƒ•ãƒˆè¡¨ã®ã‚«ã‚¹ã‚¿ãƒ æç”»é–¢æ•°ï¼ˆå…¨ã‚¹ã‚¿ãƒƒãƒ•è¡¨ç¤ºã€10äººåˆ†å›ºå®šã€30æ—¥åˆ†è¡¨ç¤ºï¼‰
        const DAYS_TO_DISPLAY = 30;
        const MIN_STAFF_ROWS = 10;
        
        // script.jsã®renderShiftTableã‚’å®Œå…¨ã«ç½®ãæ›ãˆã‚‹
        let isCustomRenderActive = false;
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
        async function customRenderShiftView() {
            if (isCustomRenderActive) {
                console.log('âš ï¸ æ—¢ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã§ã™');
                return;
            }
            
            isCustomRenderActive = true;
            
            try {
                console.log('ğŸ“Š ã‚·ãƒ•ãƒˆè¡¨ã‚’æç”»ä¸­...');
                
                // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
                const token = localStorage.getItem('shift_auth_token');
                if (!token) {
                    console.error('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
                    isCustomRenderActive = false;
                    return;
                }
                
                // å…¨ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’å–å¾—
                const staffResponse = await fetch(`${API_BASE_URL}/api/staff`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!staffResponse.ok) {
                    throw new Error('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const staffData = await staffResponse.json();
                if (!staffData.success) {
                    throw new Error(staffData.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼');
                }
                
                // å…¨ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¡¨ç¤º
                const allStaff = staffData.staff || [];
                console.log(`âœ… å…¨ã‚¹ã‚¿ãƒƒãƒ•: ${allStaff.length}å`);
                
                // ã‚·ãƒ•ãƒˆè¦æœ›ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                await loadShiftRequests();
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æç”»ï¼ˆ30æ—¥åˆ†ï¼‰
                renderCustomHeader();
                
                // ãƒœãƒ‡ã‚£ã‚’æç”»ï¼ˆå…¨ã‚¹ã‚¿ãƒƒãƒ•ï¼‰
                renderCustomBody(allStaff);
                
                // é›†è¨ˆã‚’æ›´æ–°
                updateSummaries();
                
            } catch (error) {
                console.error('âŒ ã‚·ãƒ•ãƒˆè¡¨æç”»ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚·ãƒ•ãƒˆè¡¨ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                isCustomRenderActive = false;
            }
        }
        
        // ã‚·ãƒ•ãƒˆè¦æœ›ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadShiftRequests() {
            try {
                const token = localStorage.getItem('shift_auth_token');
                const year = window.appState?.currentYear || new Date().getFullYear();
                const month = window.appState?.currentMonth || (new Date().getMonth() + 1);
                
                console.log(`ğŸ“… ${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...`);
                
                const response = await fetch(
                    `${API_BASE_URL}/api/shift-requests/get?year=${year}&month=${month}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error('ã‚·ãƒ•ãƒˆè¦æœ›ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const data = await response.json();
                
                // ã‚·ãƒ•ãƒˆè¦æœ›ã‚’ appState.shifts ã«æ ¼ç´
                if (!window.appState) window.appState = {};
                window.appState.shifts = {};
                
                if (data.success && data.shifts) {
                    Object.entries(data.shifts).forEach(([dateStr, homes]) => {
                        const [y, m, day] = dateStr.split('-').map(Number);
                        
                        Object.entries(homes).forEach(([home, shiftCodes]) => {
                            Object.entries(shiftCodes).forEach(([shiftCode, users]) => {
                                users.forEach(user => {
                                    if (user.status === 1) { // æ‰¿èªæ¸ˆã¿ã®ã¿
                                        if (!window.appState.shifts[user.user_id]) {
                                            window.appState.shifts[user.user_id] = {};
                                        }
                                        window.appState.shifts[user.user_id][day.toString()] = {
                                            code: shiftCode,
                                            home: home
                                        };
                                    }
                                });
                            });
                        });
                    });
                    
                    console.log('âœ… ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', window.appState.shifts);
                } else {
                    console.log('ğŸ“­ ã“ã®æœˆã®ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('âŒ ã‚·ãƒ•ãƒˆè¦æœ›å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚shiftsã‚’åˆæœŸåŒ–
                if (!window.appState) window.appState = {};
                window.appState.shifts = {};
            }
        }
        
        function renderCustomHeader() {
            const thead = document.getElementById('shift-table-header');
            let html = '<tr><th>ã‚¹ã‚¿ãƒƒãƒ•å</th>';
            
            // ç¾åœ¨ã®å¹´æœˆã‹ã‚‰30æ—¥åˆ†ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
            const year = window.appState?.currentYear || new Date().getFullYear();
            const month = window.appState?.currentMonth || (new Date().getMonth() + 1);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            for (let day = 1; day <= DAYS_TO_DISPLAY && day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
                const isSunday = date.getDay() === 0;
                const isSaturday = date.getDay() === 6;
                
                let headerClass = '';
                if (isSunday) headerClass = 'text-danger';
                else if (isSaturday) headerClass = 'text-primary';
                
                html += `<th class="${headerClass}">${day}æ—¥<br><small>(${dayOfWeek})</small></th>`;
            }
            
            html += '<th>æœˆåˆè¨ˆ</th></tr>';
            thead.innerHTML = html;
        }
        
        function renderCustomBody(staffList) {
            const tbody = document.getElementById('shift-table-body');
            let html = '';
            
            const year = window.appState?.currentYear || new Date().getFullYear();
            const month = window.appState?.currentMonth || (new Date().getMonth() + 1);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // å®Ÿéš›ã®ã‚¹ã‚¿ãƒƒãƒ•è¡Œã‚’æç”»
            staffList.forEach(staff => {
                html += `<tr><td>${staff.name}</td>`;
                
                const staffShifts = window.appState?.shifts?.[staff.id] || {};
                let workDays = 0;
                
                // 30æ—¥åˆ†ã®ã‚»ãƒ«ã‚’ä½œæˆï¼ˆãã®æœˆã®æ—¥æ•°ã¾ã§ï¼‰
                for (let day = 1; day <= DAYS_TO_DISPLAY && day <= daysInMonth; day++) {
                    const shift = staffShifts[day.toString()] || { code: 'NONE', home: '' };
                    const shiftInfo = window.SHIFT_CODES?.[shift.code] || { class: '', label: '' };
                    
                    const homeClass = shift.home ? `home-${shift.home.toLowerCase()}` : '';
                    
                    // ç·¨é›†ä¸å¯ã«ã™ã‚‹ãŸã‚ã«dataå±æ€§ã‚’å‰Šé™¤
                    html += `<td class="${homeClass}" style="pointer-events: none;">`;
                    
                    if (shift.code !== 'NONE') {
                        html += `<div class="shift-code ${shiftInfo.class}">${shift.code}</div>`;
                        if (!['N', 'L', 'SP'].includes(shift.code)) {
                            workDays++;
                        }
                    }
                    html += '</td>';
                }
                
                // æœˆåˆè¨ˆï¼ˆå‹¤å‹™æ—¥æ•°ï¼‰
                html += `<td><strong>${workDays}æ—¥</strong></td>`;
                html += '</tr>';
            });
            
            // 10äººã«æº€ãŸãªã„å ´åˆã¯ç©ºè¡Œã‚’è¿½åŠ 
            const currentRowCount = staffList.length;
            const emptyRowsNeeded = Math.max(0, MIN_STAFF_ROWS - currentRowCount);
            
            for (let i = 0; i < emptyRowsNeeded; i++) {
                html += '<tr class="empty-row"><td></td>';
                for (let day = 1; day <= DAYS_TO_DISPLAY && day <= daysInMonth; day++) {
                    html += '<td></td>';
                }
                html += '<td></td></tr>';
            }
            
            tbody.innerHTML = html;
        }
        
        // é›†è¨ˆã‚’æ›´æ–°
        function updateSummaries() {
            const year = window.appState?.currentYear || new Date().getFullYear();
            const month = window.appState?.currentMonth || (new Date().getMonth() + 1);
            
            console.log(`ğŸ“Š ${year}å¹´${month}æœˆã®é›†è¨ˆã‚’è¨ˆç®—ä¸­...`);
            
            // ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰åˆ¥ã®é›†è¨ˆ
            const shiftCodeCounts = {
                'A': 0,  // æ—¥å‹¤
                'B': 0,  // å¤œå‹¤
                'C': 0,  // é…ç•ª
                'EL': 0, // æ—©æœ
                'N': 0,  // å…¬ä¼‘
                'L': 0,  // æœ‰ä¼‘
                'SP': 0  // ç‰¹ä¼‘
            };
            
            // ãƒ›ãƒ¼ãƒ åˆ¥é›†è¨ˆ
            const homeStats = { A: 0, B: 0, C: 0, D: 0, E: 0 };
            
            // window.appState.shifts ã®æ§‹é€ : { user_id: { day: { code, home } } }
            if (window.appState?.shifts) {
                console.log('ğŸ” é›†è¨ˆå¯¾è±¡ãƒ‡ãƒ¼ã‚¿:', window.appState.shifts);
                
                // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚·ãƒ•ãƒˆã‚’é›†è¨ˆ
                Object.entries(window.appState.shifts).forEach(([userId, staffShifts]) => {
                    Object.entries(staffShifts).forEach(([day, shift]) => {
                        // ã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
                        if (shift.code && shiftCodeCounts[shift.code] !== undefined) {
                            shiftCodeCounts[shift.code]++;
                            console.log(`ğŸ“Š ${userId} - ${day}æ—¥: ${shift.code}`);
                        }
                        
                        // ãƒ›ãƒ¼ãƒ åˆ¥ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå…¬ä¼‘ç³»ä»¥å¤–ï¼‰
                        if (shift.home && !['N', 'L', 'SP'].includes(shift.code)) {
                            if (homeStats[shift.home] !== undefined) {
                                homeStats[shift.home]++;
                                console.log(`ğŸ  ${userId} - ${day}æ—¥: ${shift.home}ãƒ›ãƒ¼ãƒ `);
                            }
                        }
                    });
                });
            } else {
                console.warn('âš ï¸ window.appState.shifts ãŒæœªå®šç¾©ã§ã™');
            }
            
            // æœˆé–“é›†è¨ˆã‚’è¡¨ç¤ºï¼ˆã‚·ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰åˆ¥ï¼‰
            const monthlySummary = document.getElementById('monthly-summary');
            const shiftCodeLabels = {
                'A': 'æ—¥å‹¤ (A)',
                'B': 'å¤œå‹¤ (B)',
                'C': 'é…ç•ª (C)',
                'EL': 'æ—©æœ (EL)',
                'L': 'æœ‰ä¼‘ (L)',
                'N': 'å…¬ä¼‘ (N)',
                'SP': 'ç‰¹ä¼‘ (SP)'
            };
            
            let monthlyHtml = '';
            for (const [code, label] of Object.entries(shiftCodeLabels)) {
                const count = shiftCodeCounts[code] || 0;
                monthlyHtml += `
                    <li class="summary-list-item">
                        <span class="label">${label}</span>
                        <span class="value">${count}</span>
                    </li>`;
            }
            monthlySummary.innerHTML = monthlyHtml;
            
            // ãƒ›ãƒ¼ãƒ åˆ¥é›†è¨ˆã‚’è¡¨ç¤º
            const homeSummary = document.getElementById('home-summary');
            const homeLabels = { A: 'Aãƒ›ãƒ¼ãƒ ', B: 'Bãƒ›ãƒ¼ãƒ ', C: 'Cãƒ›ãƒ¼ãƒ ', D: 'Dãƒ›ãƒ¼ãƒ ', E: 'Eãƒ›ãƒ¼ãƒ ' };
            
            let homeHtml = '';
            for (const [homeKey, label] of Object.entries(homeLabels)) {
                const count = homeStats[homeKey] || 0;
                homeHtml += `
                    <li class="summary-list-item home-summary-${homeKey.toLowerCase()}">
                        <span class="label">${label}</span>
                        <span class="value">${count}æ—¥</span>
                    </li>`;
            }
            homeSummary.innerHTML = homeHtml;
            
            console.log('âœ… é›†è¨ˆå®Œäº†:', { shiftCodeCounts, homeStats });
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
        let yearChangeHandler = null;
        let monthChangeHandler = null;
        
        // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            const yearSelect = document.getElementById('year-select');
            const monthSelect = document.getElementById('month-select');
            
            if (yearSelect && yearChangeHandler) {
                yearSelect.removeEventListener('change', yearChangeHandler);
            }
            if (monthSelect && monthChangeHandler) {
                monthSelect.removeEventListener('change', monthChangeHandler);
            }
            
            console.log('ğŸ§¹ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ');
        });
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
        document.addEventListener('DOMContentLoaded', async () => {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (typeof PageRouter !== 'undefined') {
                const hasAccess = await PageRouter.checkPageAccess();
                if (!hasAccess) {
                    return; // èªè¨¼å¤±æ•—æ™‚ã¯å‡¦ç†ã‚’ä¸­æ–­
                }
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            const user = AUTH ? AUTH.getUser() : null;
            if (user) {
                console.log('ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.name, `(${user.role})`);
            }
            
            // ç¾åœ¨ã®æœˆã‚’åˆæœŸè¡¨ç¤ºã«è¨­å®š
            const now = new Date();
            const yearSelect = document.getElementById('year-select');
            const monthSelect = document.getElementById('month-select');
            
            if (yearSelect && monthSelect) {
                yearSelect.value = now.getFullYear().toString();
                monthSelect.value = (now.getMonth() + 1).toString();
                
                // appStateã‚’åˆæœŸåŒ–
                if (!window.appState) window.appState = {};
                window.appState.currentYear = now.getFullYear();
                window.appState.currentMonth = now.getMonth() + 1;
                
                // å¹´æœˆå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®šç¾©
                yearChangeHandler = async () => {
                    window.appState.currentYear = parseInt(yearSelect.value, 10);
                    window.appState.currentMonth = parseInt(monthSelect.value, 10);
                    console.log('ğŸ“… å¹´å¤‰æ›´:', window.appState.currentYear, window.appState.currentMonth);
                    await customRenderShiftView();
                };
                
                monthChangeHandler = async () => {
                    window.appState.currentYear = parseInt(yearSelect.value, 10);
                    window.appState.currentMonth = parseInt(monthSelect.value, 10);
                    console.log('ğŸ“… æœˆå¤‰æ›´:', window.appState.currentYear, window.appState.currentMonth);
                    await customRenderShiftView();
                };
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
                yearSelect.addEventListener('change', yearChangeHandler);
                monthSelect.addEventListener('change', monthChangeHandler);
                
                console.log('âœ… shift_view.html: ç‹¬è‡ªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²å®Œäº†');
            }
            
            // ã‚»ãƒ«ç·¨é›†ã‚’ç„¡åŠ¹åŒ–
            document.addEventListener('click', (e) => {
                const cell = e.target.closest('.shift-table tbody td');
                if (cell && !cell.classList.contains('empty-row')) {
                    e.stopPropagation();
                    e.preventDefault();
                }
            }, true);
            
            // åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            await customRenderShiftView();
        });
        
        // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’è¨­å®š
        document.querySelector('.back-link')?.addEventListener('click', (e) => {
            e.preventDefault();
            window.history.back();
        });
    </script>
</body>
</html>
