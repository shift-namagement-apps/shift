<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºå‹¤ç°¿ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </title>

    <style>
      .title{
        text-align: center;
        font-size: 50px;
      }  

      .form{
        font-size: 20px;
        padding: 10px;
        display: flex;
        text-align: center;
        flex-direction: column;
        align-items: center;
      }

      th h2{
        text-align: center;   
      }
      

      table {
        border-collapse: separate;
        border-spacing: 0 15px;
        margin: 0 auto;
        table-layout: fixed;  
        width: 300px;        
        border-collapse: collapse;
        margin: 20px auto;
      }
  
      select {
         width: 145px;   
        padding: 7px;   
        font-size: 18px; 
        margin-bottom: 10px;
        }

      textarea {
         width: 130px;   
        padding: 7px;   
        font-size: 18px;
        margin-bottom: 10px; 
        }

      input {
         width: 130px;   
        padding: 7px;   
        font-size: 18px; 
        margin-bottom: 10px;
        }


    table > th{
        padding: 10px;
    }

    .submit{
        margin-top: 40px;
        width: 130px;
        height: 50px;
        font-size: 18px;
    }

    td{
        margin: 30px;
    }
    </style>

</head>
<body>
 <h1 class="title">å‡ºå‹¤ç°¿ç™»éŒ²</h1>
    <form action="" class="form">
        <table>
            <tr>
                <th>
                    <label for="date">
                        æ—¥ä»˜:
                    </label>
                </th>
                <td>
                    <input type="date" id="date">
                </td>
            </tr>
            <tr>
                <th>
                    <label for="start">                        
                        å§‹æ¥­æ™‚åˆ»:
                    </label>
                </th>
                <td>
                    <input type="time" name="" id="start">
                </td>
            </tr>
            <tr>
                <th>
                    <label for="finish">
                        çµ‚æ¥­æ™‚åˆ»:
                    </label>
                </th>
                <td>
                    <input type="time" name="" id="finish">
                </td>
            </tr>
            <tr>
                <th>
                    <label for="finish">
                        ä¼‘æ†©æ™‚é–“:
                    </label>
                </th>
                <td>
                     <select id="break-time" name="break-time">
                        <option value="0.25">0æ™‚é–“15åˆ†</option>
                        <option value="0.5">0æ™‚é–“30åˆ†</option>
                        <option value="0.75">0æ™‚é–“45åˆ†</option>
                        <option value="1">1æ™‚é–“00åˆ†</option>
                        <option value="1.25">1æ™‚é–“15åˆ†</option>
                        <option value="1.5">1æ™‚é–“30åˆ†</option>
                        <option value="1.75">1æ™‚é–“45åˆ†</option>
                        <option value="2">2æ™‚é–“00åˆ†</option>
                    </select>
                </td>
            </tr>
            </table>
            <tr>
                <th>        
                    <h2 class="other">ãã®ä»–</h2>
                </th>
            </tr>
            <table>
            <tr>
                <th>
                    <label for="add">
                        å‚™è€ƒæ¬„:
                    </label>
                </th>
                <td>
                    <select  id="add">
                        <option value="add-1">å‚™è€ƒï¼‘</option>
                        <option value="add-1">å‚™è€ƒï¼’</option>
                        <option value="add-1">å‚™è€ƒï¼“</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>
                    <label for="textarea">
                    </label>
                </th>
                <td>
                    <textarea name="" id="textarea"></textarea>
                </td>
            </tr>
        <tr>
            <th>
                <label for="place">                  
               å‹¤å‹™åœ°ã‚’é¸æŠ:
                </label>
            </th>
            <td>
                <select id="place">
                    <option value="place-1">å‹¤å‹™å…ˆ1</option>
                    <option value="place-2">å‹¤å‹™å…ˆ2</option>
                    <option value="place-3">å‹¤å‹™å…ˆ3</option>
                    <option value="place-4">å‹¤å‹™å…ˆ4</option>
                    <option value="place-5">å‹¤å‹™å…ˆ5</option>
                </select>
            </td>
        </tr>
        <tr>
            <th>
                <label for="traffic">
                    äº¤é€šè²»åˆè¨ˆ(å††):
                </label>
            </th>
            <td>
                <input type="number" name="" id="traffic">
            </td>
        </tr>           
        </table>

        <input class="submit" type="submit" value="é€ä¿¡">
        
    </form>
    
    <!-- APIè¨­å®šã‚’å…ˆã«èª­ã¿è¾¼ã‚€ -->
    <script src="config.js"></script>
    <!-- èªè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="auth.js"></script>
    
    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', async () => {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            const token = localStorage.getItem('shift_auth_token');
            if (!token) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                window.location.href = window.BASE_PATH || '/shift/';
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ä¿å­˜
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.success && data.user) {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    sessionStorage.setItem('current_user', JSON.stringify(data.user));
                    console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—:', data.user);
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // å‚™è€ƒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨å‹¤å‹™åœ°ã‚’èª­ã¿è¾¼ã¿
            await loadBikouTemplates();
            await loadWorkplaces();
        });
        
        // å‚™è€ƒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
        async function loadBikouTemplates() {
            try {
                const token = localStorage.getItem('shift_auth_token');
                const response = await fetch(`${API_BASE_URL}/api/bikou-templates`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.templates.length > 0) {
                    const select = document.getElementById('add');
                    select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                    
                    data.templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.text;
                        option.textContent = template.text;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('å‚™è€ƒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // å‹¤å‹™åœ°ã‚’èª­ã¿è¾¼ã¿
        async function loadWorkplaces() {
            try {
                const token = localStorage.getItem('shift_auth_token');
                console.log('ğŸ  å‹¤å‹™åœ°ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...');
                console.log('ğŸ”— URL:', `${API_BASE_URL}/api/homes`);
                
                const response = await fetch(`${API_BASE_URL}/api/homes`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('ğŸ“¥ å‹¤å‹™åœ°ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status, response.statusText);
                const data = await response.json();
                console.log('ğŸ“Š å‹¤å‹™åœ°ãƒ‡ãƒ¼ã‚¿:', data);
                
                if (data.success && data.homes && data.homes.length > 0) {
                    const select = document.getElementById('place');
                    select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                    
                    data.homes.forEach(home => {
                        const option = document.createElement('option');
                        // valueã¨textContentã®ä¸¡æ–¹ã‚’çµ±ä¸€
                        option.value = home.name;
                        option.textContent = home.name + 'ãƒ›ãƒ¼ãƒ ';
                        select.appendChild(option);
                        console.log('âœ… å‹¤å‹™åœ°è¿½åŠ :', home.name);
                    });
                    console.log('âœ… å‹¤å‹™åœ°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å®Œäº†');
                } else {
                    console.warn('âš ï¸ å‹¤å‹™åœ°ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                    console.warn('ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹:', data);
                }
            } catch (error) {
                console.error('âŒ å‹¤å‹™åœ°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // å‚™è€ƒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠæ™‚ã«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«å…¥åŠ›
        document.getElementById('add').addEventListener('change', function() {
            const textarea = document.getElementById('textarea');
            if (this.value) {
                // æ—¢å­˜ã®å†…å®¹ãŒã‚ã‚‹å ´åˆã¯æ”¹è¡Œã—ã¦è¿½åŠ 
                if (textarea.value) {
                    textarea.value += '\\n' + this.value;
                } else {
                    textarea.value = this.value;
                }
            }
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
        document.querySelector('form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // å…¥åŠ›å€¤ã‚’å–å¾—
            const date = document.getElementById('date').value;
            const startTime = document.getElementById('start').value;
            const endTime = document.getElementById('finish').value;
            const breakTime = document.getElementById('break-time').value;
            const notes = document.getElementById('textarea').value;
            const workplace = document.getElementById('place').value;
            const transportationCost = document.getElementById('traffic').value || 0;
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!date || !startTime || !endTime) {
                alert('æ—¥ä»˜ã€å§‹æ¥­æ™‚åˆ»ã€çµ‚æ¥­æ™‚åˆ»ã¯å¿…é ˆã§ã™');
                return;
            }
            
            // é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            const attendanceData = {
                date: date,
                start_time: startTime,
                end_time: endTime,
                break_time: parseFloat(breakTime),
                notes: notes,
                workplace: workplace,
                transportation_cost: parseInt(transportationCost)
            };
            
            console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', attendanceData);
            
            // APIã«é€ä¿¡
            try {
                const token = localStorage.getItem('shift_auth_token');
                console.log('ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª:', token ? 'å­˜åœ¨' : 'æœªè¨­å®š');
                
                if (!token) {
                    alert('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    window.location.href = window.BASE_PATH || '/shift/';
                    return;
                }
                
                console.log('ğŸ“¡ é€ä¿¡å…ˆURL:', `${API_BASE_URL}/api/attendance`);
                console.log('ğŸ“¤ é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(attendanceData, null, 2));
                
                const response = await fetch(`${API_BASE_URL}/api/attendance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceData)
                });
                
                console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status, response.statusText);
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã—ã¦ãƒ­ã‚°å‡ºåŠ›
                const responseText = await response.text();
                console.log('ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('âŒ JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
                    console.error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆ:', responseText);
                    alert('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                console.log('âœ… ãƒ‘ãƒ¼ã‚¹çµæœ:', result);
                
                if (result.success) {
                    const sheetsStatus = result.sheets_result?.success ? 'âœ… æ›¸ãè¾¼ã¿æˆåŠŸ' : 'âŒ æ›¸ãè¾¼ã¿å¤±æ•—';
                    const sheetsMessage = result.sheets_result?.message || result.sheets_result?.error || '';
                    
                    alert(`å‡ºå‹¤ç°¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸ\n\nâœ… Firestore: ä¿å­˜æˆåŠŸ\n${sheetsStatus}\n${sheetsMessage}`);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    this.reset();
                    
                    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å†è¨­å®š
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('date').value = today;
                    
                    // å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ã‹ã€ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    // window.history.back();
                } else {
                    console.error('âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:', result.error);
                    alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
                }
            } catch (error) {
                console.error('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
                alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        });
    </script>
</body>
</html>
