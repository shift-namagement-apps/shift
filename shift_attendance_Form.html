<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>出勤簿登録フォーム</title>

    <style>
      .title{
        text-align: center;
        font-size: 50px;
      }  

      .form{
        font-size: 20px;
        padding: 10px;
        display: flex;
        text-align: center;
        flex-direction: column;
        align-items: center;
      }

      th h2{
        text-align: center;   
      }
      

      table {
        border-collapse: separate;
        border-spacing: 0 15px;
        margin: 0 auto;
        table-layout: fixed;  
        width: 300px;        
        border-collapse: collapse;
        margin: 20px auto;
      }
  
      select {
         width: 145px;   
        padding: 7px;   
        font-size: 18px; 
        margin-bottom: 10px;
        }

      textarea {
         width: 130px;   
        padding: 7px;   
        font-size: 18px;
        margin-bottom: 10px; 
        }

      input {
         width: 130px;   
        padding: 7px;   
        font-size: 18px; 
        margin-bottom: 10px;
        }


    table > th{
        padding: 10px;
    }

    .submit{
        margin-top: 40px;
        width: 130px;
        height: 50px;
        font-size: 18px;
    }

    td{
        margin: 30px;
    }
    </style>

</head>
<body>
 <h1 class="title">出勤簿登録</h1>
    <form action="" class="form">
        <table>
            <tr>
                <th>
                    <label for="date">
                        日付:
                    </label>
                </th>
                <td>
                    <input type="date" id="date">
                </td>
            </tr>
            <tr>
                <th>
                    <label for="start">                        
                        始業時刻:
                    </label>
                </th>
                <td>
                    <input type="time" name="" id="start">
                </td>
            </tr>
            <tr>
                <th>
                    <label for="finish">
                        終業時刻:
                    </label>
                </th>
                <td>
                    <input type="time" name="" id="finish">
                </td>
            </tr>
            <tr>
                <th>
                    <label for="finish">
                        休憩時間:
                    </label>
                </th>
                <td>
                     <select id="break-time" name="break-time">
                        <option value="0.25">0時間15分</option>
                        <option value="0.5">0時間30分</option>
                        <option value="0.75">0時間45分</option>
                        <option value="1">1時間00分</option>
                        <option value="1.25">1時間15分</option>
                        <option value="1.5">1時間30分</option>
                        <option value="1.75">1時間45分</option>
                        <option value="2">2時間00分</option>
                    </select>
                </td>
            </tr>
            </table>
            <tr>
                <th>        
                    <h2 class="other">その他</h2>
                </th>
            </tr>
            <table>
            <tr>
                <th>
                    <label for="add">
                        備考欄:
                    </label>
                </th>
                <td>
                    <select  id="add">
                        <option value="add-1">備考１</option>
                        <option value="add-1">備考２</option>
                        <option value="add-1">備考３</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>
                    <label for="textarea">
                    </label>
                </th>
                <td>
                    <textarea name="" id="textarea"></textarea>
                </td>
            </tr>
        <tr>
            <th>
                <label for="place">                  
               勤務地を選択:
                </label>
            </th>
            <td>
                <select id="place">
                    <option value="place-1">勤務先1</option>
                    <option value="place-2">勤務先2</option>
                    <option value="place-3">勤務先3</option>
                    <option value="place-4">勤務先4</option>
                    <option value="place-5">勤務先5</option>
                </select>
            </td>
        </tr>
        <tr>
            <th>
                <label for="traffic">
                    交通費合計(円):
                </label>
            </th>
            <td>
                <input type="number" name="" id="traffic">
            </td>
        </tr>           
        </table>

        <input class="submit" type="submit" value="送信">
        
    </form>
    
    <!-- API設定を先に読み込む -->
    <script src="config.js"></script>
    <!-- 認証スクリプト -->
    <script src="auth.js"></script>
    
    <script>
        // ページ読み込み時に設定データを取得
        document.addEventListener('DOMContentLoaded', async () => {
            // 認証チェック
            const token = localStorage.getItem('shift_auth_token');
            if (!token) {
                alert('ログインが必要です');
                window.location.href = window.BASE_PATH || '/shift/';
                return;
            }
            
            // 今日の日付をデフォルト設定
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // 備考テンプレートと勤務地を読み込み
            await loadBikouTemplates();
            await loadWorkplaces();
        });
        
        // 備考テンプレートを読み込み
        async function loadBikouTemplates() {
            try {
                const token = localStorage.getItem('shift_auth_token');
                const response = await fetch(`${API_BASE_URL}/api/bikou-templates`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.templates.length > 0) {
                    const select = document.getElementById('add');
                    select.innerHTML = '<option value="">選択してください</option>';
                    
                    data.templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.text;
                        option.textContent = template.text;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('備考テンプレート取得エラー:', error);
            }
        }
        
        // 勤務地を読み込み
        async function loadWorkplaces() {
            try {
                const token = localStorage.getItem('shift_auth_token');
                const response = await fetch(`${API_BASE_URL}/api/homes`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.homes.length > 0) {
                    const select = document.getElementById('place');
                    select.innerHTML = '<option value="">選択してください</option>';
                    
                    data.homes.forEach(home => {
                        const option = document.createElement('option');
                        option.value = home.name + 'ホーム';
                        option.textContent = home.name + 'ホーム';
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('勤務地取得エラー:', error);
            }
        }
        
        // 備考テンプレート選択時にテキストエリアに入力
        document.getElementById('add').addEventListener('change', function() {
            const textarea = document.getElementById('textarea');
            if (this.value) {
                // 既存の内容がある場合は改行して追加
                if (textarea.value) {
                    textarea.value += '\\n' + this.value;
                } else {
                    textarea.value = this.value;
                }
            }
        });
        
        // フォーム送信時の処理
        document.querySelector('form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 入力値を取得
            const date = document.getElementById('date').value;
            const startTime = document.getElementById('start').value;
            const endTime = document.getElementById('finish').value;
            const breakTime = document.getElementById('break-time').value;
            const notes = document.getElementById('textarea').value;
            const workplace = document.getElementById('place').value;
            const transportationCost = document.getElementById('traffic').value || 0;
            
            // バリデーション
            if (!date || !startTime || !endTime) {
                alert('日付、始業時刻、終業時刻は必須です');
                return;
            }
            
            // 送信データを作成
            const attendanceData = {
                date: date,
                start_time: startTime,
                end_time: endTime,
                break_time: parseFloat(breakTime),
                notes: notes,
                workplace: workplace,
                transportation_cost: parseInt(transportationCost)
            };
            
            console.log('送信データ:', attendanceData);
            
            // APIに送信
            try {
                const token = localStorage.getItem('shift_auth_token');
                if (!token) {
                    alert('認証トークンがありません。再ログインしてください。');
                    window.location.href = window.BASE_PATH || '/shift/';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/api/attendance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(attendanceData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('出勤簿を登録しました\\n\\nFirestore: 保存成功\\nGoogle Sheets: ' + 
                          (result.sheets_result.success ? '書き込み成功' : '書き込み失敗'));
                    
                    // フォームをリセット
                    this.reset();
                    
                    // 今日の日付を再設定
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('date').value = today;
                    
                    // 前のページに戻るか、ホームに戻る
                    // window.history.back();
                } else {
                    alert('エラー: ' + result.error);
                }
            } catch (error) {
                console.error('送信エラー:', error);
                alert('送信中にエラーが発生しました: ' + error.message);
            }
        });
    </script>
</body>
</html>
